## C. メッセージ（タイムライン・返信ツリー・リアクション・添付・コンテキスト）仕様書【v1.0 確定】

本章は、家族向けアプリにおける **メッセージ機能（機能C）** の確定仕様を定義する。  
機能Cは、A（在庫・買い物・出費）および B（スケジュール・通知）では扱いにくい  
**文脈・補足・相談・確認といった非構造コミュニケーション**を担う。

---

## C-0. 基本方針（全体前提）

- メッセージは **家族共通の1タイムライン**で運用する
- 返信ツリー（スレッド分岐）をサポートする
- リアクション（👍などの絵文字）をサポートする
- 添付ファイル（画像・PDF）をサポートする
- A / B のデータに紐づく補足会話（コンテキスト付きメッセージ）を実装する
- 新規メッセージ・返信・リアクションは **すべて全員に通知**する
- メッセージの編集・削除は **全員可能**
- 添付ファイルの上限（枚数・サイズ）は **仕様上は設けない**  
  （実際の制限はインフラ側の上限に従う）

---

## C-1. 機能範囲

### C-1.1 v1.0で提供する機能

- 家族共通1タイムライン（時系列表示）
- 返信ツリー（親メッセージへの返信）
- リアクション（絵文字）
- 添付ファイル（画像・PDF）
- 既読管理（タイムライン単位）
- 新規メッセージ／返信／リアクション通知
- A/Bコンテキスト紐づきメッセージ
- コンテキストサジェスト
- メッセージ編集
- メッセージ削除（ソフトデリート）＋削除ログ

### C-1.2 v1.0で意図的に行わないこと

- 1対1 DM
- メンション（@user）
- ピン留め
- 高度検索（全文検索）
- チャンネル／ルーム分割

---

## C-2. メッセージ構造（タイムライン＋返信ツリー）

### C-2.1 設計方針

- タイムライン表示と返信ツリーを **同一Messageエンティティ**で表現する
- タイムラインは、親・子を区別せず **createdAt順**に表示する
- 返信ツリーは `parentMessageId` / `rootMessageId` を用いてUIで展開する

---

## C-3. Message データモデル

### C-3.1 必須項目

- `messageId`
- `householdId`
- `senderMemberId`
- `body`：本文（短文、改行可）
- `createdAt`
- `type`：`free` / `context`
- `parentMessageId`：返信の場合のみ
- `rootMessageId`：スレッドの起点（親が無い場合は自身の messageId）

### C-3.2 任意項目

- `contextType`：  
  `inventoryLot` / `shoppingTask` / `receipt` / `familyEvent` / `googleBusy` / `reminder`
- `contextRefId`：紐づけ先ID
- `editedAt`
- `editVersion`
- `deletedAt`
- `version`（競合制御用）

### C-3.3 削除時の表示

- `deletedAt` が設定されたメッセージは本文を表示せず  
  置換文言を表示する  
  例：「このメッセージは削除されました」

---

## C-4. リアクション（Reaction）

### C-4.1 概要

- 任意のメッセージに対して絵文字リアクションを付与できる
- 同一ユーザーが同一メッセージに同一絵文字を複数付与することはできない

### C-4.2 データモデル

- `reactionId`
- `messageId`
- `memberId`
- `emoji`
- `createdAt`

**推奨制約**

- 一意制約：`(messageId, memberId, emoji)`

---

## C-5. 添付ファイル（Attachment）

### C-5.1 対応範囲

- v1.0では **画像・PDF** を対象とする

### C-5.2 データモデル

- `attachmentId`
- `messageId`
- `uploaderMemberId`
- `fileType`：`image` / `pdf`
- `fileName`
- `fileSize`
- `mimeType`
- `storageUrl`
- `thumbnailUrl`（任意）
- `createdAt`

### C-5.3 UI表示

- 画像：インライン表示、タップで拡大
- PDF：カード表示、タップで閲覧

---

## C-6. A/Bコンテキスト紐づきメッセージ

### C-6.1 概要

- A/Bの対象データに紐づけてメッセージを投稿できる
- `type = context` とし、`contextType` / `contextRefId` を保持する
- タイムライン上では、紐づき先を示すラベルを表示する

### C-6.2 コンテキストサジェスト

メッセージ入力時に、関連しそうなA/B対象を候補として提示する。

**サジェスト対象（v1.0）**

- 在庫：期限が近い／lowFlagのロット
- 出費：直近のレシート
- 家族イベント：今日・明日のイベント
- Google busy：次のbusy時間帯
- リマインド：直近の未完了リマインド

**適用方法**

- ユーザーが候補を選択した場合のみ  
  `contextType` / `contextRefId` を設定する
- 本文は自動変更しない

---

## C-7. 既読管理（ReadState）

### C-7.1 単位

- v1.0では **メンバー × タイムライン**単位で既読を管理する

### C-7.2 データモデル

- `householdId`
- `memberId`
- `lastReadAt`（または `lastReadMessageId`）
- `updatedAt`

---

## C-8. 通知仕様

### C-8.1 通知対象

- 新規メッセージ：通知する
- 返信：通知する
- リアクション：通知する

### C-8.2 通知内容（最小）

- 送信者名
- 種別（新規／返信／リアクション）
- 本文の先頭（短縮表示）
- コンテキストラベル（存在する場合）

※ 静音時間帯の扱いは、機能Bの通知仕様と整合させる

---

## C-9. 編集（Edit）仕様

### C-9.1 編集可能範囲

- 本文の編集
- 添付の追加・削除
- コンテキストの付け替え

### C-9.2 編集履歴

- v1.0では詳細な履歴UIは提供しない
- 以下のメタ情報は保持する（推奨）：
  - `editedAt`
  - `editVersion`

---

## C-10. 削除（Delete）仕様

### C-10.1 削除ポリシー

- メッセージ削除は **全員可能**
- 物理削除は行わず、**ソフトデリート**とする
- 会話構造を壊さないため、置換表示を残す

### C-10.2 削除ログ（監査ログ）

以下を必須とする。

- entityType（Message / Attachment / Reaction）
- entityId
- action = DELETE
- actorMemberId
- at
- snapshot（任意）

---

## C-11. 競合ポリシー

- 更新は **後勝ちで適用**
- `baseVersion != currentVersion` の場合：
  - 更新は適用する
  - **後から操作したユーザーに警告**を表示する

対象：

- メッセージ編集
- メッセージ削除
- 添付追加・削除
- リアクション追加・削除

---

## C-12. 将来拡張候補（v1.1+）

- 全文検索
- ピン留め
- メンション
- DM（1対1）
- リアクション通知の粒度制御
- 添付ファイル種別拡張（動画等）

```
