## E. 設定・横断ルール・非機能要件（Security / Sync / Ops）仕様書【v1.0 確定】

本章は、機能 A/B/C/D を安定運用するための **設定・横断ルール・非機能要件（機能E）** を定義する。  
同期事故・通知事故・データ破損・家族内トラブルを抑止することを目的とする。

---

## E-0. 基本方針（確定）

- アプリは **Householdを1つだけ作成**する前提で設計する（Q1）
  - 将来増える可能性はあるが、v1.0は単一Household前提
- メンバーはフラット（ロールなし）
- 家族からの退出は **不可**（Q2）
- ログ保持期間は **3ヶ月**で自動削除（Q3）
- 削除は原則ソフトデリートで扱い、監査ログで追跡可能にする

---

## E-1. 設定の階層モデル

設定は以下の3階層で管理する。

1. **グローバル（アプリ）**
2. **Household（家族共通）**
3. **メンバー個人**

---

## E-2. アカウント／Household 管理

### E-2.1 Household（家族単位）

- Household は単一作成（v1.0）
- Household 内データは、Householdメンバーのみ参照・操作可能

**最小データ**

- `householdId`
- `name`
- `currency`（デフォルト JPY）
- `createdAt`

---

### E-2.2 Member（家族メンバー）

- メンバーは Household に属する
- 表示名は変更可能

**最小データ**

- `memberId`
- `householdId`
- `displayName`
- `joinedAt`
- `status`（active / disabled 等）

---

### E-2.3 退出ポリシー（確定）

- メンバーの「自発的退出」は **不可**
- 退出が必要な場合は、運用上の対応（例：無効化）で扱う
  - v1.0では「メンバー無効化」UIの提供有無は任意  
    （ただし退出不可のため、運用導線は必要）

---

## E-3. 通知・静音・配信の最終制御

### E-3.1 通知配信の最終判定フロー（共通）

1. ドメイン（B/C）が通知を生成
2. Household共通ルールを適用
3. メンバー個人の静音時間を適用
4. 配信／抑制を決定

### E-3.2 静音時間（個人設定）

- メンバーごとに静音時間帯を設定可能
- 静音時間中は OS通知を抑制する
- 抑制された情報はホーム（D）のインボックスで回復可能とする

---

## E-4. 同期・競合・オフライン耐性

### E-4.1 競合ポリシー（全ドメイン共通）

- 楽観ロック（`version`）を採用
- **後勝ちで適用**
- `baseVersion != currentVersion` の場合：
  - 更新は適用する
  - **後から変更したユーザーに警告**を表示する

対象：

- A：在庫／買い物／出費
- B：イベント／Google busy／リマインド
- C：メッセージ／返信／リアクション／添付

---

### E-4.2 オフライン動作（v1.0最小）

- オフライン時：
  - 閲覧は可能（キャッシュ範囲は実装依存）
  - 作成・更新はローカルキューに積む
- 復帰時：
  - キューを順次同期
  - 競合発生時は後勝ち適用＋警告
- 差分比較UI（マージUI）は v1.0では提供しない

---

## E-5. 削除・監査・ログ保持

### E-5.1 削除方針（統一）

- 物理削除は原則行わず、ソフトデリートで扱う
- ただしログ保持期間により、ログは期限到来で物理削除され得る

---

### E-5.2 監査ログ／削除ログ（必須）

監査ログは以下を最低要件として保持する。

- `entityType`
- `entityId`
- `action`（CREATE / UPDATE / DELETE）
- `actorMemberId`
- `at`
- `snapshot`（任意）

対象（例）：

- A-4 レシート削除ログ
- B-5 リマインド削除ログ
- C メッセージ／添付／リアクション削除ログ

---

### E-5.3 ログ保持期間（確定）

- 監査ログ／削除ログは **3ヶ月（90日相当）**保持し、期限到来で自動削除する
- 保持期間の起点：
  - 原則 `at`（操作日時）
- 自動削除はバッチ処理で実行する（実行時刻は実装依存）

---

## E-6. セキュリティ・プライバシー（v1.0最低ライン）

### E-6.1 アクセス制御

- Household 内のみ参照・操作可能
- Household を跨ぐ参照は禁止

### E-6.2 添付ファイル（Cとの整合）

- 添付は認可されたメンバーのみアクセス可能とする
- 推奨：署名付きURLで配信し、一定時間で失効する
- 添付URLは外部公開されない（検索エンジン非公開）

### E-6.3 Googleカレンダー連携（Bとの整合）

- 取得・共有するのは **busy時間帯のみ**
- タイトル等の詳細情報は保存しない（または表示しない）
- 同期に必要なイベントID等は内部用として保持可能

---

## E-7. 設定UI（v1.0最小）

### E-7.1 家族共通設定（Household）

- Household名
- 通貨（デフォルト JPY）
- Google連携状態（連携ON/OFF、最終同期時刻など）

### E-7.2 個人設定（Member）

- 表示名
- 静音時間帯

---

## E-8. v1.0で意図的に行わないこと

- 管理者ロール／権限階層
- 操作ログの高度検索／閲覧UI
- 削除データの自己復旧UI
- 複数Household所属／複数Household作成
- 高度な通知ルール（条件分岐、集約配信、優先度制御）

---

## E-9. 将来拡張候補（v1.1+）

- 複数Household対応
- 退出／追放（メンバー管理）UIの整備
- 監査ログ保持期間のカスタム
- 通知の集約・フィルタリング
- 競合の差分比較UI
