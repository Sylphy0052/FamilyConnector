## F. パーソナライゼーション／メディア 仕様書【v1.0 確定】

本章は、家族共有アプリにおける **パーソナライゼーション（個人テーマ）** および  
**メディア（画像・PDF 等のアセット管理）** の確定仕様を定義する。

A（在庫・出費）、C（メッセージ）、D（横断UX）と密接に関係するため、  
**見た目の自由度とUXの安全性、メディア表示性能の両立**を主眼とする。

---

## F-0. 基本方針（確定）

- パーソナライゼーションは **Member（個人）単位**
- テーマ配色は **完全な自由編集（任意HEX指定）**（Q1）
- アバターは **画像のみ**
- メディアは統一して **Asset** として管理する
- 表示最適化（低解像度／段階読み込み等）は **v1.0で必須**（Q2）
- Assetの削除も **削除ログ対象**とする（Q3）
- 各ドメインは URL 直持ちではなく **assetId 正**で参照する

---

## F-1. 個人テーマ（Personal Theme）

### F-1.1 目的

- 個人ごとにアプリの配色を自由にカスタマイズできるようにする
- ただし、D（ホーム・警告・未読）の可読性を破壊しない

---

### F-1.2 編集方式（確定）

- ユーザーは **任意の色（HEX/RGB等）を自由入力**できる
- プリセットや制限は設けない
- 編集対象は **配色トークンのみ**（レイアウト・フォントは固定）

---

### F-1.3 Theme Manifest（データモデル）

- `themeId`
- `ownerMemberId`
- `manifestVersion`
- `tokens`
- `updatedAt`

#### tokens（v1.0 必須）

- `color.background`
- `color.surface`
- `color.textPrimary`
- `color.textSecondary`
- `color.accent`
- `color.warning`
- `color.success`

---

### F-1.4 バリデーションとフォールバック（重要）

- フォーマット不正（色指定として解釈不可）は保存不可
- **可読性が担保できない配色**の場合：
  - 該当テーマは無効
  - **デフォルトテーマへ一括フォールバック**
- フォールバックは画面単位ではなく **テーマ単位**

> 可読性判定の具体的アルゴリズム（WCAG等）は実装依存とし、  
> 仕様としては「可読性を担保できない場合はフォールバックする」ことを要件とする。

---

## F-2. アバター（Member Avatar）

### F-2.1 目的

- 誰の操作・発言かを即時識別できるようにする

### F-2.2 仕様（確定）

- アバターは **画像のみ**
- 未設定時はシステム既定アイコンを表示
- イニシャル生成等は v1.0では必須としない

### F-2.3 データモデル

- `memberId`
- `avatarAssetId`（任意）
- `avatarUpdatedAt`

---

## F-3. メディア管理（Asset Management）

### F-3.1 対象アセット（v1.0）

- アバター画像
- レシート画像（A-4 OCR用）
- メッセージ添付（画像・PDF）
- テーマ関連補助アセット（必要な場合）

---

### F-3.2 Asset データモデル（確定）

- `assetId`
- `householdId`
- `ownerMemberId`
- `assetType`  
  - `avatar`
  - `receipt`
  - `message_image`
  - `message_pdf`
  - `theme_asset`
- `mimeType`
- `fileName`
- `fileSize`
- `storageUrl`
- `createdAt`
- `deletedAt`（ソフトデリート）

---

### F-3.3 ドメイン参照ルール

- A-4 Receipt → `receiptImageAssetId`
- C Message → `attachmentAssetId`
- Member → `avatarAssetId`

※ URLは再署名・失効前提のため、永続参照は **assetId のみ**

---

## F-4. 表示最適化（Performance / UX）【v1.0 必須】

### F-4.1 基本方針（確定）

- 元データは保持しつつ、**表示用に最適化されたデータを使用**する
- 最適化は **表示専用**であり、原本は破壊しない

---

### F-4.2 画像表示最適化

#### 対象

- レシート画像
- メッセージ添付画像
- アバター画像

#### 要件

- 初期表示は **低解像度または軽量版**
- ユーザー操作（タップ等）で **高解像度版を読み込む**
- モバイル回線前提で表示が破綻しないこと

※ 実装方式（リサイズ済画像、CDN変換、段階ロード等）は実装依存

---

### F-4.3 PDF表示最適化

- 初期表示は **メタ情報＋簡易プレビュー**
- 本文はユーザー操作でロード
- 全文一括ロードを前提としない

---

## F-5. 削除ポリシーとログ（Q3反映）

### F-5.1 削除方針

- Asset削除は **ソフトデリート**
- 参照元（レシート・メッセージ）が削除されても即物理削除しない
- 孤児Assetは発生し得る（v1.0ではGC必須としない）

---

### F-5.2 削除ログ（必須）

Assetの削除も、E章の監査ログ方針に従う。

**最低要件**

- entityType = Asset
- entityId
- action = DELETE
- actorMemberId
- at
- snapshot（fileName / assetType 等、任意）

---

## F-6. D（横断UX）との整合ルール

- テーマにより以下が視認不能になってはならない：
  - 未読表示
  - 警告（在庫期限、出費差分、競合）
  - 重要アクション導線
- 不可の場合はテーマ無効化＋フォールバック

---

## F-7. v1.0で意図的に行わないこと

- テーマ共有・マーケット
- アバター高度編集（トリミングUI、エフェクト）
- 動画・音声添付
- Asset検索・タグ付けUI
- 孤児Assetの自動削除UI

---

## F-8. 将来拡張候補（v1.1+）

- テーマプリセット＋自由編集の併用
- 家族内テーマ共有（複製）
- サムネイルキャッシュの高度化
- 孤児Assetの自動GC
- 添付メディア種別拡張（動画・音声）
