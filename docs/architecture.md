# 全体アーキテクチャまとめ（A〜G 統合）【v1.0】

本ドキュメントは、機能A〜Gで確定した仕様を前提に、全体を一貫したアーキテクチャとして整理する。  
目的は「ドメイン分割」「データ/同期/通知/メディアの横断設計」「UIハブ（ホーム）による回収設計」を明確化し、実装・運用のブレを止めることにある。

---

## 1. ドメイン境界（Bounded Context）と責務

### 1.1 ドメイン一覧（確定）

| ドメイン | 役割 | 主要エンティティ |
|---|---|---|
| A：共同生活オペレーション | 生活実務データ（在庫・買い物・出費） | InventoryLot, ShoppingTask, Receipt, ReceiptLineItem |
| B：スケジュール・通知 | 時間・行動喚起（イベント/busy/リマインド） | FamilyEvent, GoogleBusyBlock, Reminder |
| C：メッセージ | 文脈・補足・相談（返信/リアクション/添付/コンテキスト） | Message, Reaction, Attachment |
| D：横断UX | ホーム・ウィジェット・ナビ・回収設計 | Home Blocks, Inbox, Quick Actions |
| E：設定・非機能 | 単一Household・退出不可・ログ3ヶ月・静音 | Household, Member, Audit/Delete Log, Quiet Hours |
| F：パーソナライゼーション/メディア | 個人テーマ・アバター・Asset・表示最適化 | Theme, Asset |
| G：同期・整合性・実装制約 | Delta sync・後勝ち＋警告・通知一意・バッチ/キュー | Sync State, Warning Event, Jobs/Queues |

---

## 2. 全体データモデル（概念レベル）

### 2.1 共有の“軸”エンティティ

- **Household（単一）**
  - すべての共有データは householdId に所属
- **Member**
  - ロールなし
  - 退出不可（無効化で対応）

### 2.2 横断エンティティ

- **Asset（F）**
  - avatar / receipt / message_image / message_pdf 等を統一管理
- **Audit / Delete Log（E）**
  - 3ヶ月保持で自動削除（バッチ）
- **Warning Event（G）**
  - version mismatch 等の競合警告（UIで回収）
- **Notification（B/C）**
  - 生成はドメイン、配信は共通キュー
  - 同一（sourceEntity × recipient）一意

---

## 3. UIアーキテクチャ（Dがハブ）

### 3.1 ホーム優先順位（確定）

- **C（未読があれば） > A（要対応） > B（時間軸）**
- これにより通知の見逃しから回復できる（ホーム＝インボックス）

### 3.2 ホーム4ブロック（確定）

1. **メッセージ・インボックス（未読時のみ最上段）**
2. **要対応（在庫期限/lowFlag、出費差分・OCR未確定、競合警告）**
3. **今日の時間軸（イベント・busy・リマインド同列）**
4. **クイックアクション（レシートOCR、在庫追加、買い物追加、リマインド、投稿）**

### 3.3 ナビゲーション（推奨）

- ホーム / 在庫 / 買い物 / 出費 / メッセージ /（任意）予定

### 3.4 重要な設計意図

- B/Cは通知が多い前提のため、**通知抑制ではなくUIで吸収**（要対応・インボックス）
- 警告はOS通知にしない（疲労増大を防止）

---

## 4. 同期・整合性（G：v1.0の“背骨”）

### 4.1 Source of Truth

- サーバ正（最終状態はサーバで確定）

### 4.2 Delta Sync（確定）

- クライアントは `lastSyncedAt` を保持し、
  - `updatedAt > lastSyncedAt` の差分を取得してローカル更新

### 4.3 冪等性（必須）

- 変更操作に `clientRequestId` を付与し、再送時の重複適用を防止
- 通知・ログ・派生処理も同一操作につき1回のみ

### 4.4 競合（後勝ち＋警告）

- `baseVersion != currentVersion` でも更新は適用（後勝ち）
- 警告イベントを生成し、D（要対応）で回収

---

## 5. 通知アーキテクチャ（B/C主導＋共通配信）

### 5.1 通知種別

- B：家族イベント（複数オフセット）
- B：Google busy（入力式オフセット、ノイズ抑制なし）
- B：リマインド（完了で削除＋ログ）
- C：新規メッセージ／返信／リアクション（全員通知）

### 5.2 一意性保証（確定）

- `(notificationType, sourceEntityId, recipientMemberId)` で一意
- 同一受信者へ同一ソース通知は1回のみ

### 5.3 静音（E）

- 個人ローカル静音時間でOS通知抑制
- 抑制されてもDホームに未消化情報が残り回復可能

---

## 6. メディア（F）と表示最適化（F×G）

### 6.1 Asset統一

- 各ドメインは URLではなく `assetId` を参照（移行・失効に強い）

### 6.2 表示最適化（必須）

- 軽量版生成はサーバ側で自動生成
- 初期表示は軽量版、操作で高解像へ段階ロード
- PDFも初期はメタ＋簡易プレビュー、操作で本文ロード

### 6.3 上限なし要件の吸収

- UI上は上限を設けないが、物理上限は存在するため
  - 失敗時の明確なエラー/再試行導線を必須要件化（G）

---

## 7. バッチ／ジョブ／キュー（G×E×A×B×C）

### 7.1 定期バッチ（必須）

- 監査/削除ログの期限削除（3ヶ月）
- 在庫 qty=0 の翌日0:00削除（当日は横線表示）
- 買い物タスク done → 1日後削除
- レシート削除 → LineItemも一括論理削除（整合性保持）

### 7.2 キュージョブ（必須）

- OCR（レシート画像→抽出→LineItem候補→手修正）
- 通知生成・配信（ドメイン処理から分離し、遅延/再試行/重複防止）

---

## 8. セキュリティ／プライバシー（E×F×G）

- Household内アクセスに限定（越境不可）
- Googleカレンダー連携は busyのみ共有（詳細は扱わない）
- 添付は認可付きアクセス（署名URL等）を前提
- 削除ログは3ヶ月保持で自動削除

---

## 9. 典型フロー（統合シナリオ）

### 9.1 レシートOCR→出費確定（A-4 × F × G）

1. 画像アップロード → Asset登録
2. OCRジョブでLineItem候補生成
3. ユーザーが手修正（画像は添付として保持）
4. Receipt合計≠LineItem合計なら差分警告
5. ホーム要対応に警告が出る（カテゴリ集計はLineItem、総計はReceipt）

### 9.2 メッセージ添付＋返信＋リアクション（C × F × G）

1. Message作成（clientRequestId）
2. 返信は parent/root を保持
3. 添付は assetId 参照
4. 新規/返信/リアクションは全員通知（重複防止キーで一意）

### 9.3 競合（A/B/C共通）→警告回収（G × D）

1. baseVersion不一致で更新
2. 後勝ち適用
3. Warning Event生成
4. ホーム要対応で回収（OS通知にしない）

---

## 10. 実装優先順位（MVPの組み立て指針）

1. 共通基盤：Household/Member、Auth、Delta Sync、clientRequestId冪等
2. F/G：Asset登録＋軽量版生成＋段階ロード
3. A-4：Receipt/OCR/手修正＋差分警告
4. C：Message＋返信＋リアクション＋添付＋未読
5. B：FamilyEvent/GoogleBusy/Reminder＋通知一意
6. D：ホーム（未読＞要対応＞時間軸）＋ウィジェット

---

# 付録：未確定だが後で効く論点（列挙のみ）

- 退出不可の運用導線（無効化UIの有無）
- “通知疲れ”の運用（将来の集約/粒度制御）
- 孤児AssetのGC（一定期間後回収）
- 多Household化（将来拡張）
