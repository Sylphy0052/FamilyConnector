## B. スケジュール・通知（Schedule & Notification）仕様書【v1.0 確定】

本章は、家族向けアプリにおける **スケジュール管理および通知機能（機能B）** の確定仕様を定義する。  
機能Bは「通知して終わり」ではなく、**家族内での予定把握・行動喚起・確認の完了までを一貫して扱う**ことを目的とする。

---

## B-0. 基本方針（全体前提）

- 通知は **家族全員に配信**される
- メンバーは全員フラット（ロール・権限差なし）
- 通知には **3種類**が存在し、それぞれ目的・状態・完了概念が異なる
- 通知の配信は共通レイヤで扱い、ドメインごとに通知を生成する
- 競合は **後勝ちで適用し、後から変更したユーザーに警告**する

---

## B-1. 通知の分類（一次分類）

### B-1.1 通知タイプ一覧

| 種類 | 名称 | 主目的 | 完了概念 |
|---|---|---|---|
| T1 | 家族イベント通知 | 家族予定の共有 | なし |
| T2 | Google busy 通知 | 予定あり時間帯の共有 | なし |
| T3 | リマインド通知 | 行動喚起・確認回収 | あり |

---

## B-2. 通知共通レイヤ（Notification）

### B-2.1 役割

- 実際の「通知配信」を担う共通エンティティ
- Event / Google busy / Reminder から生成される

### B-2.2 データモデル（最小）

- `notificationId`
- `householdId`
- `type`：`family_event` / `google_busy` / `reminder`
- `fireAt`：通知時刻
- `payload`：表示用最小情報（タイトル、時刻など）
- `createdAt`

※ 通知自体は完了状態を持たない

---

## B-3. 家族イベント（Family Event）【T1】

### B-3.1 概要

- アプリ内で管理される家族共有イベント
- 家族全員が作成・編集・削除可能
- **繰り返しイベントをサポート**
- **終了時通知は行わない**

---

### B-3.2 通知仕様（確定）

- イベントごとに通知設定を持つ
- 通知設定は **カスタム入力式**
  - 単位：分 / 時間 / 日
  - 例：10分前、2時間前、1日前
- 複数通知設定を許容（推奨）
- 通知はイベント開始時刻基準

---

### B-3.3 繰り返し仕様（確定）

v1.0 で対応する繰り返しパターンは以下。

1. 毎日
2. 毎週 ◯曜日
3. 隔週 ◯曜日
4. 第n ◯曜日（例：第2火曜日）

#### 推奨表現

- iCal RRULE 互換表現を採用する

---

### B-3.4 データモデル（最小）

- `eventId`
- `householdId`
- `title`
- `startAt`
- `endAt`（任意）
- `rrule`（繰り返し設定）
- `notifyOffsets[]`  
  - `offsetValue`（数値）
  - `offsetUnit`（minutes / hours / days）
- `createdBy`
- `createdAt`
- `updatedAt`
- `version`

---

### B-3.5 UI要件

- カレンダー／タイムライン表示
- Google busy ブロックと **同列（横並び）表示**

---

## B-4. Googleカレンダー連携（Busy Block）【T2】

### B-4.1 共有情報（確定）

- 家族へ共有するのは **busyの時間帯のみ**
- 以下の情報は共有しない：
  - タイトル
  - 場所
  - 参加者
  - 詳細内容

---

### B-4.2 UI（確定）

- トップページおよびウィジェットで  
  **「次のbusy時間帯」** を確認可能
  - 例：次の予定あり：13:00–14:30

---

### B-4.3 通知仕様（確定）

- busy開始の **<設定時間>前**に通知
- <設定時間>は **入力式**
  - 数値 + 単位（分 / 時間 / 日）
- ノイズ抑制：**行わない**

#### 通知時刻算出ルール

- `fireAt = busyStartAt - offset`
- `fireAt` が過去になる場合：
  - v1.0では **通知しない**

---

### B-4.4 データモデル（最小）

- `blockId`
- `householdId`
- `memberId`（内部参照用）
- `startAt`
- `endAt`
- `notifyOffsetValue`
- `notifyOffsetUnit`
- `sourceEventId`（Google側ID）
- `createdAt`
- `updatedAt`
- `version`

---

## B-5. リマインド（Reminder）【T3】

### B-5.1 概要

- 時間と内容を指定して通知する
- **行動喚起および確認回収**が目的
- 通知後は「完了（確認）」によって収束させる

---

### B-5.2 完了・削除仕様（確定）

- リマインドはチェック操作で **完了（確認）**
- 完了したリマインドは **削除扱い**とする
  - UI上から消える
- 削除時は **削除ログを必ず残す**

---

### B-5.3 データモデル（最小）

- `reminderId`
- `householdId`
- `title`
- `body`（任意）
- `fireAt`
- `createdBy`
- `createdAt`
- `doneBy`
- `doneAt`
- `status`：`pending` / `done` / `deleted`
- `version`

---

### B-5.4 削除ログ（監査ログ）

最低限以下を記録する。

- entityType = Reminder
- entityId
- action = DELETE
- actorMemberId
- at
- snapshot（任意）

---

## B-6. 競合ポリシー（共通）

- 更新は **後勝ちで適用**
- `baseVersion != currentVersion` の場合：
  - 更新は適用する
  - **後から変更したユーザーに警告**を表示する

対象：

- 家族イベント
- Google busy ブロック
- リマインド

---

## B-7. v1.0 で意図的に行わないこと

- 通知ノイズ抑制ロジック
- 通知の既読管理
- 家族イベント／Google busy の完了確認
- リマインドのアーカイブ表示
- 権限・ロール管理

---

## B-8. 将来拡張候補（v1.1+）

- Google busy 通知のまとめ配信
- 家族イベントの例外日（EXDATE）
- リマインドのスヌーズ高度化
- 通知ごとの優先度制御

```
