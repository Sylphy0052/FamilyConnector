## G. 同期・整合性・実装制約（Sync / Consistency / Infra）仕様書【v1.0 確定】

本章は、A〜Fで確定した機能仕様を **安定的・再現可能・事故耐性のある形で実装／運用**するための  
同期モデル、整合性モデル、バックグラウンド処理、メディア配信制約を定義する。

---

## G-0. 基本方針（確定）

- **サーバを唯一の正（Source of Truth）**とする
- クライアントはオフライン操作を許容し、復帰時に同期する
- 同期は **最終同期時刻以降の差分取得（Delta Sync）**を採用（Q1）
- 競合は **後勝ちで適用＋後操作ユーザーに警告**
- 通知は **同一イベント／メッセージ × 同一受信者につき1回のみ配信**を保証（Q2）
- メディアの表示最適化用「軽量版」は **サーバ側で自動生成**（Q3）

---

## G-1. 同期モデル（Delta Sync）

### G-1.1 同期単位

- すべての主要エンティティは以下を持つ：
  - `updatedAt`（サーバ時刻）
  - `version`（楽観ロック用）

対象：

- A：InventoryLot / ShoppingTask / Receipt / ReceiptLineItem
- B：FamilyEvent / GoogleBusyBlock / Reminder
- C：Message / Reaction / Attachment
- F：Theme / Asset

---

### G-1.2 クライアント同期フロー（確定）

1. クライアントは `lastSyncedAt` を保持
2. 同期開始時に以下を送信：
   - `lastSyncedAt`
3. サーバは：
   - `updatedAt > lastSyncedAt` のエンティティ差分を返却
4. クライアントはローカル状態を更新
5. 同期完了時に `lastSyncedAt` を更新

---

### G-1.3 作成・更新・削除の送信（冪等性）

- すべての変更操作に以下を付与する：
  - `clientRequestId`（UUID）
  - `baseVersion`
- サーバは以下を保証：
  - 同一 `clientRequestId` の再送は **重複適用しない**
  - 通知・ログ・派生処理も **1回のみ実行**

---

## G-2. 整合性モデル（後勝ち＋警告）

### G-2.1 更新ルール（統一）

- サーバは更新要求を **必ず受理**する
- `baseVersion != currentVersion` の場合：
  - 更新は **後勝ちで適用**
  - 警告イベントを生成

---

### G-2.2 警告イベント

**最低要件**

- `entityType`
- `entityId`
- `operation`（UPDATE / DELETE 等）
- `reason = version_mismatch`
- `actorMemberId`
- `at`

**扱い**

- 警告は OS 通知では送らない
- D（ホーム）の「要対応」ブロックで回収する

---

### G-2.3 参照整合（ソフトデリート前提）

- 参照元削除時：
  - メッセージ：プレースホルダ表示（C）
  - レシート：LineItemも一括論理削除（A-4）
- 参照先解決失敗時：
  - Asset 取得失敗 → 「取得できません」表示＋再試行導線

---

## G-3. オフライン耐性

### G-3.1 オフライン時の挙動

- 閲覧：可能（キャッシュ範囲は実装依存）
- 作成・更新・削除：
  - ローカルキューに積む
  - UI上は即時反映（楽観表示）

---

### G-3.2 復帰時

- キューを順次送信
- 冪等性により重複適用を防止
- 競合時は後勝ち適用＋警告表示

---

## G-4. 通知の生成・配信（重複防止）

### G-4.1 通知生成

対象：

- B：家族イベント（複数オフセット）
- B：Google busy（入力式オフセット）
- C：新規メッセージ／返信／リアクション

---

### G-4.2 重複防止ルール（確定）

- 通知は以下のキーで一意とする：
  - `(notificationType, sourceEntityId, recipientMemberId)`
- 同一キーの通知は **1回のみ生成・配信**

---

### G-4.3 配信方式

- 通知生成と配信は **非同期キュー**
- 再試行時も重複配信しない

---

## G-5. バックグラウンド処理（ジョブ）

### G-5.1 定期バッチ（必須）

- 監査ログ／削除ログの期限削除（E：3ヶ月）
- 在庫 qty=0 の翌日 0:00 削除（A-2）
- 買い物タスク done 後 1日で削除（A-3）
- リマインド完了時削除＋ログ（B/C）

---

### G-5.2 キュージョブ（必須）

- OCR 抽出ジョブ（A-4）
  - 画像保存 → OCR → LineItem 候補生成
  - 失敗時は手入力モードへフォールバック

---

## G-6. メディア（Asset）実装制約

### G-6.1 アップロード

- 署名付き URL による直接アップロード
- 完了後に Asset 登録 → 各ドメインは `assetId` を参照

---

### G-6.2 表示最適化（必須）

#### 画像

- サーバ側で自動的に **軽量版（低解像／圧縮）を生成**
- 初期表示：軽量版
- 操作時：原本または高解像版を取得

#### PDF

- 初期表示：メタ情報＋簡易プレビュー
- 本文はユーザー操作時にロード

※ `thumbnailUrl` は持たない  
※ URL パラメータや変換 API 等の実装方式は自由

---

## G-7. “上限なし”要件の吸収（システム保護）

- UI上は明示的な上限を設けない
- ただし以下は必須：
  - 失敗時の明確なエラーハンドリング
  - 再試行導線
  - 「サイズが大きすぎる可能性」等のガイダンス表示

---

## G-8. 監視・運用（最低要件）

- 同期失敗率／再試行回数
- 通知配信成功率（種別別）
- OCR 成功率／手修正率
- メディア取得失敗率
- バッチ実行成功／失敗

---

## G-9. v1.0で意図的に行わないこと

- リアルタイム双方向同期（WebSocket 等）
- 競合の差分マージ UI
- 同期ログのユーザー向け可視化
- 添付の物理上限値の明示

---

## G-10. 仕様確定メモ

- 同期方式：**最終同期時刻以降の差分取得**
- 通知：**同一イベント／同一受信者1回**
- メディア軽量版：**サーバ側自動生成**
