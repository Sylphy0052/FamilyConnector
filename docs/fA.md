## A. 共同生活オペレーション（在庫・買い物・出費）仕様書【v1.0 確定】

本章は、家族向けアプリにおける **実務データ管理領域（機能A）** の確定仕様を定義する。  
機能Aは「生活を回すための実務情報」を扱い、**通知・完了回収を主目的としない軽量ドメイン**として設計する。

---

## A-0. 基本方針（全体前提）

- すべてのデータは **Household 単位で共有**
- メンバーは全員フラット（ロール・権限差なし）
- 在庫・買い物・出費は **論理的に分離**
- 通知は原則行わない  
  （通知が必要な場合は機能B＝リマインド/イベントに委譲）
- 競合は **後勝ちで適用し、後から変更したユーザーに警告**

---

## A-1. 機能構成

機能Aは以下の3領域で構成される。

| サブ機能 | 名称 | 目的 |
|---|---|---|
| A-2 | 在庫管理 | 家にある物の状態把握 |
| A-3 | 買い物リスト | 補充すべき物の一時管理 |
| A-4 | 出費管理 | 家計の支出可視化 |

---

## A-2. 在庫管理（InventoryLot）

### A-2.1 目的

- 家庭内の物品を **購入単位（ロット）**で管理する
- 履歴を持たず、現在状態のみを扱う

---

### A-2.2 データモデル（確定）

**必須**

- `lotId`
- `householdId`
- `itemName`：品目名
- `qty`：数量（整数）
- `purchaseDate`：購入日（YYYY-MM-DD、今日以外入力可）
- `category`：カテゴリ（未分類を含む）
- `lowFlag`：低在庫フラグ（ON/OFF）
- `status`：`active` / `pending_delete`

**任意**

- `expiryDate`：期限日
- `labels[]`：ラベル（0..n）
- `deleteAt`：削除予定日時（pending_delete時）

※ `location（場所）` は扱わない

---

### A-2.3 カテゴリ・ラベル

#### カテゴリ

- ユーザーが作成可能
- **未分類を必ず許容**
- 在庫は必ず1カテゴリに属する

#### ラベル

- 全メンバーが作成可能
- 在庫ロットに複数付与可能
- Household 共有

---

### A-2.4 数量操作

- 数量変更は以下を許容：
  - **絶対値指定**
  - **差分操作**
- 実装上は操作種別を区別する

---

### A-2.5 qty = 0 の扱い（削除ルール）

- qty が 0 になった場合：
  - 即時削除しない
  - 当日中は一覧に残し **横線表示**
  - `status = pending_delete`
- 削除タイミング：
  - **翌日 0:00** に自動削除
- 当日中に qty を 1 以上に戻した場合：
  - `status = active` に戻し、削除予定を解除

---

### A-2.6 低在庫

- 低在庫は **手動ON/OFF**
- 自動判定（閾値）は行わない

---

### A-2.7 履歴・通知

- 在庫管理は **履歴を保持しない**
- 在庫操作自体では通知を行わない  
  （必要な場合はB機能のリマインドを利用）

---

### A-2.8 競合ポリシー

- 後勝ちで更新を適用
- baseVersion 不一致時：
  - 更新は適用
  - **後から変更したユーザーに警告**

---

## A-3. 買い物リスト（ShoppingTask）

### A-3.1 目的

- 補充が必要な物を **一時的に管理**
- 強制力・通知を持たない軽量タスク

---

### A-3.2 データモデル（確定）

**必須**

- `taskId`
- `householdId`
- `itemName`
- `status`：`open` / `done`（チェックボックス）
- `createdBy`

**任意**

- `qty`
- `category`（未分類可）
- `labels[]`
- `dueDate`
- `priority`
- `doneBy`
- `doneAt`

---

### A-3.3 在庫 → 買い物 引き継ぎ

在庫ロットから作成する場合：

- 引き継ぐ：
  - `itemName`
  - `category`
  - `labels`
- 引き継がない：
  - `qty`

---

### A-3.4 lowFlag との連動

- 在庫の `lowFlag` を ON にした場合：
  - **自動生成はしない**
  - 「買い物タスクを作成する」導線のみ表示

---

### A-3.5 完了と削除

- done にすると当日中は一覧に残る
- **1日経過後に自動削除**
- 別画面（アーカイブ）は設けない

---

### A-3.6 在庫連携（提案型）

- done 時に **在庫追加を提案**
- 必須ではない

---

### A-3.7 通知・責任

- 買い物タスクでは **通知を行わない**
- 担当者割当・エスカレーションは行わない

---

## A-4. 出費管理（Expense / Receipt）

### A-4.1 目的

- 家計支出を **レシート単位**で記録・可視化
- 在庫管理とは分離

---

### A-4.2 データモデル概要

#### Receipt（レシート）

**必須**

- `receiptId`
- `householdId`
- `date`（YYYY-MM-DD）
- `totalAmount`（整数、JPY）
- `currency`（デフォルト JPY）
- `createdBy`
- `createdAt`
- `version`
- `status`：`active` / `deleted`

**任意**

- `receiptImageUrl`
- `merchantId` / `merchantName`
- `memo`

#### ReceiptLineItem（品目）

**必須**

- `lineItemId`
- `receiptId`
- `itemName`
- `expenseCategory`
- `source`：`ocr` / `manual`

**任意**

- `qty`
- `unitPrice`
- `lineAmount`
- `inferredCategoryConfidence`

---

### A-4.3 レシート画像OCR

- レシート画像をアップロード可能
- OCRで以下を抽出（可能な範囲）：
  - 店舗名
  - 合計金額
  - 購入品目
- 抽出結果は **手動修正可能**
- OCR精度不足時：
  - 画像を添付として保存
  - 品目を手入力で補完

#### UI

- スマホ：上に画像／下に入力（デフォルトはOCR値）
- Web：左に画像／右に入力（デフォルトはOCR値）

---

### A-4.4 出費カテゴリ

- 品目（LineItem）ごとにカテゴリを設定
- 設定方法：
  - 一律設定 → 個別変更
  - 自動推定 → 手動修正
- 既存カテゴリ選択 or 新規追加
- 「よく使うカテゴリ」は設けない

---

### A-4.5 集計ルール（重要）

- **カテゴリ別集計の正は LineItem**
- 合計不一致時：
  - カテゴリ集計：LineItem 合計
  - 総計：Receipt.totalAmount
  - 差分警告を表示
- 合計のみ入力の場合：
  - `未分類` の LineItem を1件自動生成

---

### A-4.6 店舗サジェスト

- 店舗名入力時、DBからサジェスト
- 新規店舗追加可能

---

### A-4.7 削除ポリシー

- レシート削除は **全員可能**
- 物理削除せず **ソフトデリート**
- LineItem も一括で論理削除
- 削除ログを必ず残す

---

### A-4.8 競合ポリシー

- 後勝ちで更新を適用
- baseVersion 不一致時：
  - 更新は適用
  - **後から変更したユーザーに警告**

---

## A-5. v1.0で意図的に行わないこと

- 在庫履歴管理
- 在庫と出費の自動突合
- 買い物タスク通知
- 家計精算・割り勘
- 権限・ロール管理

```
